<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Golf Tee Times</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; padding: 16px; line-height: 1.35; background:#f7f7f7; }
      .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; background: #fff; }
      .muted { color: #666; font-size: 13px; margin-top: 6px; }
      h1 { font-size: 20px; margin: 0 0 10px 0; }
      h2 { font-size: 17px; margin: 16px 0 8px 0; }
      ul { padding-left: 18px; }
      li { margin: 6px 0; }
      a { word-break: break-word; }
      button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #fff; }
      button:active { transform: scale(0.99); }
      .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="row">
        <h1 style="margin:0;">Latest Tee Times</h1>
        <button id="refreshBtn">Refresh now</button>
      </div>
      <div class="muted" id="status">Loading…</div>
      <hr />
      <div id="content"></div>
    </div>

    <script>
      const REFRESH_MS = 120000; // 2 min

      function escapeHtml(s) {
        return (s ?? "").toString()
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function groupByCourse(results) {
        const map = new Map();
        for (const r of results) {
          if (!map.has(r.course)) map.set(r.course, []);
          map.get(r.course).push(r);
        }
        return map;
      }

      async function loadResults() {
        const status = document.getElementById("status");
        const content = document.getElementById("content");

        try {
          status.textContent = "Loading…";
          content.innerHTML = "";

          // cache-bust so iPhone actually fetches the new JSON
          const url = "results.json?v=" + Date.now();
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error("Could not load results.json (" + res.status + ")");

          const data = await res.json();

          status.textContent =
            `Updated: ${data.updated_utc} • Date: ${data.play_date} • Filter: ${data.min_players}+ players before ${data.latest_time}`;

          const byCourse = groupByCourse(data.results || []);
          let html = "";

          if (!data.results || data.results.length === 0) {
            html += "<p>No tee times matched.</p>";
          } else {
            for (const [course, items] of byCourse.entries()) {
              html += `<h2>${escapeHtml(course)}</h2><ul>`;
              for (const r of items) {
                const players = r.players ? ` ${escapeHtml(r.players)}` : "";
                html += `<li><strong>${escapeHtml(r.tee_time)}</strong>${players} <a href="${escapeHtml(r.booking_url)}" target="_blank" rel="noopener noreferrer">open booking page</a></li>`;
              }
              html += "</ul>";
            }
          }

          if (data.errors && data.errors.length) {
            html += "<h2>Errors</h2><ul>";
            for (const e of data.errors) {
              html += `<li><strong>${escapeHtml(e.course)}</strong>: ${escapeHtml(e.message)} <a href="${escapeHtml(e.booking_url)}" target="_blank" rel="noopener noreferrer">open booking page</a></li>`;
            }
            html += "</ul>";
          }

          content.innerHTML = html;
        } catch (err) {
          status.textContent = "Failed to load results. Pull down / refresh and try again.";
          content.innerHTML = `<p class="muted">${escapeHtml(err.message || err)}</p>`;
        }
      }

      document.getElementById("refreshBtn").addEventListener("click", loadResults);

      loadResults();
      setInterval(loadResults, REFRESH_MS);

      // also refresh when you come back to the tab
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) loadResults();
      });
    </script>
  </body>
</html>
